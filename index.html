<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食材価格トラッキング・ダッシュボード (クラウド対応版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 40vh; width: 100%; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay">
        <div class="flex items-center">
            <div class="loader"></div>
            <p class="ml-4 text-gray-700">データベースに接続中...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">食材価格トラッキング・ダッシュボード</h1>
            <p class="text-gray-600 mt-2">日々の買い物を記録して、賢く節約しましょう。</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- ===== 入力・履歴セクション ===== -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">買い物データを入力</h2>
                <form id="item-form" class="space-y-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">購入日</label>
                        <input type="date" id="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">品目名（カテゴリ）</label>
                        <input type="text" id="item-name" placeholder="例: 食パン, 牛乳" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <!-- ★★★ 変更点: 銘柄/詳細の入力欄を追加 ★★★ -->
                    <div>
                        <label for="brand-name" class="block text-sm font-medium text-gray-700">銘柄/詳細（任意）</label>
                        <input type="text" id="brand-name" placeholder="例: ロイヤルブレッド, おいしい牛乳" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">価格（円）</label>
                        <input type="number" id="price" placeholder="例: 198" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">数量</label>
                            <input type="number" id="quantity" value="1" step="any" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="unit" class="block text-sm font-medium text-gray-700">単位</label>
                            <input type="text" id="unit" placeholder="例: 斤, L, g, 本" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                     <div>
                        <label for="store-name" class="block text-sm font-medium text-gray-700">スーパー名</label>
                        <input type="text" id="store-name" placeholder="例: ○○スーパー" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                        記録する
                    </button>
                </form>

                <hr class="my-6">
                
                <h2 class="text-xl font-bold mb-4 border-b pb-2">購入履歴</h2>
                <div class="h-64 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品目</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">価格 (単価)</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="bg-white divide-y divide-gray-200">
                            <!-- 履歴はここに表示されます -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ===== ダッシュボードセクション ===== -->
            <div class="lg:col-span-2 space-y-8">
                <!-- サマリー -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-lg text-center">
                        <h3 class="text-sm font-medium text-gray-500">記録アイテム数</h3>
                        <p id="total-items" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-lg text-center">
                        <h3 class="text-sm font-medium text-gray-500">ユニーク品目数</h3>
                        <p id="unique-items" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-lg text-center">
                        <h3 class="text-sm font-medium text-gray-500">総支出額</h3>
                        <p id="total-spending" class="mt-1 text-3xl font-semibold text-gray-900">¥0</p>
                    </div>
                </div>

                <!-- 価格推移グラフ -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">単価推移</h2>
                        <div>
                            <label for="item-select" class="sr-only">品目を選択</label>
                            <select id="item-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>

                <!-- 最安値情報 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">品目別 最安値リスト (単価ベース)</h2>
                    <div id="min-price-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- 最安値情報がここに表示されます -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 同期セクション -->
        <div id="sync-section" class="bg-blue-100 border border-blue-300 text-blue-800 p-4 rounded-xl shadow-lg mt-8 lg:col-span-3">
            <h3 class="font-bold">PCとスマホのデータを同期する</h3>
            <p class="text-sm mt-2">PCで表示された「マイ同期ID」をスマホで入力すると、同じデータを共有できます。</p>
            <div class="mt-4">
                <button id="show-id-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">マイ同期IDを表示</button>
                <p id="my-id-display" class="mt-2 text-xs font-mono select-all bg-white p-2 rounded" style="display:none;"></p>
            </div>
            <div class="mt-4">
                <label for="sync-id-input" class="text-sm font-medium">同期IDを入力:</label>
                <div class="flex items-center mt-1">
                    <input type="text" id="sync-id-input" placeholder="PCのIDをここに貼り付け" class="block w-full border border-gray-300 rounded-md shadow-sm py-1 px-2 text-sm">
                    <button id="sync-btn" class="ml-2 bg-green-500 text-white py-1 px-3 rounded-md hover:bg-green-600">同期</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCEfuv2gtUZwTT7TNSHMan6Omi5TMSBLOU",
          authDomain: "shopping-dashboard-app.firebaseapp.com",
          projectId: "shopping-dashboard-app",
          storageBucket: "shopping-dashboard-app.appspot.com",
          messagingSenderId: "352515834159",
          appId: "1:352515834159:web:a0e58334e05feaabbd61da"
        };

        const loadingOverlay = document.getElementById('loading-overlay');

        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("AIzaSyA")) {
             loadingOverlay.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg text-center shadow-md"><h3 class="font-bold text-lg">Firebaseの設定エラー</h3><p class="mt-1">FirebaseのAPIキーが設定されていません。</p></div>`;
        } else {
            const itemForm = document.getElementById('item-form');
            const dateInput = document.getElementById('date');
            const itemNameInput = document.getElementById('item-name');
            // ★★★ 変更点: 新しいUI要素を取得 ★★★
            const brandNameInput = document.getElementById('brand-name');
            const priceInput = document.getElementById('price');
            const quantityInput = document.getElementById('quantity');
            const unitInput = document.getElementById('unit');
            const storeNameInput = document.getElementById('store-name');
            const historyTable = document.getElementById('history-table');
            const itemSelect = document.getElementById('item-select');
            const totalItemsEl = document.getElementById('total-items');
            const uniqueItemsEl = document.getElementById('unique-items');
            const totalSpendingEl = document.getElementById('total-spending');
            const minPriceListEl = document.getElementById('min-price-list');
            
            const showIdBtn = document.getElementById('show-id-btn');
            const myIdDisplay = document.getElementById('my-id-display');
            const syncIdInput = document.getElementById('sync-id-input');
            const syncBtn = document.getElementById('sync-btn');

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let currentUserId = null;
            let itemsUnsubscribe = null;
            let chart;
            let localItems = [];

            dateInput.value = new Date().toISOString().split('T')[0];
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const targetUserId = localStorage.getItem('shoppingDashboardUserId') || user.uid;
                    currentUserId = targetUserId;
                    localStorage.setItem('shoppingDashboardUserId', currentUserId);
                    setupRealtimeListener(currentUserId);
                } else {
                    signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
                }
            });

            function setupRealtimeListener(userId) {
                if (itemsUnsubscribe) itemsUnsubscribe();
                const itemsCollectionRef = collection(db, "users", userId, "items");
                const q = query(itemsCollectionRef);
                itemsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    localItems = [];
                    querySnapshot.forEach((doc) => localItems.push({ id: doc.id, ...doc.data() }));
                    renderAll();
                    loadingOverlay.style.display = 'none';
                }, (error) => {
                    console.error("Error fetching data: ", error);
                    loadingOverlay.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"><h3 class="font-bold">データ取得エラー</h3><p>権限がないか、IDが間違っている可能性があります。</p></div>`;
                });
            }
            
            const renderAll = () => {
                renderHistory();
                renderSummary();
                renderMinPriceList();
                updateItemSelector();
                renderChart();
            };

            // ★★★ 変更点: 履歴表示で銘柄も表示 ★★★
            const renderHistory = () => {
                historyTable.innerHTML = '';
                const recentItems = [...localItems].sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                recentItems.forEach((item) => {
                    const row = document.createElement('tr');
                    
                    let unitPriceText = '';
                    if (item.normalizedUnitPrice) {
                        unitPriceText = `(¥${item.normalizedUnitPrice.toFixed(1)}/${item.normalizedUnit})`;
                    }

                    const brandText = item.brand ? `<div class="text-xs text-gray-500">${item.brand}</div>` : '';

                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.name}</div>
                            ${brandText}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                            <div>¥${item.price.toLocaleString()}</div>
                            <div class="text-xs text-gray-500">${unitPriceText}</div>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-red-600 hover:text-red-900" data-id="${item.id}">削除</button>
                        </td>`;
                    historyTable.appendChild(row);
                });
                historyTable.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        if (confirm('このデータを本当に削除しますか？')) {
                            await deleteDoc(doc(db, "users", currentUserId, "items", e.target.dataset.id));
                        }
                    });
                });
            };
            
            const renderSummary = () => {
                totalItemsEl.textContent = localItems.length;
                uniqueItemsEl.textContent = new Set(localItems.map(item => item.name)).size;
                totalSpendingEl.textContent = `¥${localItems.reduce((sum, item) => sum + Number(item.price), 0).toLocaleString()}`;
            };

            // ★★★ 変更点: 最安値リストで銘柄も表示 ★★★
            const renderMinPriceList = () => {
                minPriceListEl.innerHTML = '';
                const uniqueItemNames = [...new Set(localItems.map(item => item.name))];
                uniqueItemNames.forEach(name => {
                    if (!name) return;
                    const itemsOfName = localItems.filter(item => item.name === name && item.normalizedUnitPrice != null);
                    if (itemsOfName.length === 0) return;

                    const minPriceItem = itemsOfName.reduce((min, item) => item.normalizedUnitPrice < min.normalizedUnitPrice ? item : min);
                    
                    const brandText = minPriceItem.brand ? `(${minPriceItem.brand})` : '';

                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${name} ${brandText}</p>
                            <p class="text-xs text-gray-500">${minPriceItem.date} at ${minPriceItem.store || 'お店不明'} (${minPriceItem.quantity}${minPriceItem.unit || ''}で¥${minPriceItem.price})</p>
                        </div>
                        <p class="font-bold text-lg text-indigo-600">¥${minPriceItem.normalizedUnitPrice.toFixed(1)}<span class="text-sm font-normal">/${minPriceItem.normalizedUnit}</span></p>`;
                    minPriceListEl.appendChild(el);
                });
            };

            const updateItemSelector = () => {
                const uniqueItemNames = [...new Set(localItems.map(item => item.name))].sort();
                const currentSelection = itemSelect.value;
                itemSelect.innerHTML = '<option value="">品目を選択...</option>';
                uniqueItemNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    itemSelect.appendChild(option);
                });
                if (uniqueItemNames.includes(currentSelection)) {
                    itemSelect.value = currentSelection;
                } else if (uniqueItemNames.length > 0) {
                    itemSelect.value = uniqueItemNames[0];
                }
            };
            
            // ★★★ 変更点: グラフのツールチップで銘柄を表示 ★★★
            const renderChart = () => {
                const selectedItemName = itemSelect.value;
                if (chart) chart.destroy();
                if (!selectedItemName) return;

                const itemData = localItems
                    .filter(item => item.name === selectedItemName && item.normalizedUnitPrice != null)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (itemData.length === 0) return;

                const labels = itemData.map(item => item.date);
                const data = itemData.map(item => item.normalizedUnitPrice);
                const unit = itemData[0].normalizedUnit;

                const ctx = document.getElementById('price-chart').getContext('2d');
                chart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [{ 
                            label: `${selectedItemName} の単価 (円/${unit})`, 
                            data: data, 
                            borderColor: 'rgb(79, 70, 229)', 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)', 
                            fill: true, 
                            tension: 0.1 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: false, ticks: { callback: value => '¥' + value.toLocaleString() } } }, 
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: context => {
                                        const item = itemData[context.dataIndex];
                                        const brandText = item.brand ? ` (${item.brand})` : '';
                                        return `単価: ¥${context.parsed.y.toFixed(2).toLocaleString()}${brandText}`;
                                    } 
                                } 
                            } 
                        } 
                    } 
                });
            };

            // ★★★ 変更点: フォーム送信時に銘柄も保存 ★★★
            itemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserId) return;

                const price = parseInt(priceInput.value);
                const quantity = parseFloat(quantityInput.value) || 1;
                const unit = unitInput.value.trim();
                
                let unitPrice = price / quantity;
                let normalizedUnitPrice = unitPrice;
                let normalizedUnit = unit || '個';

                const unitLower = unit.toLowerCase();
                if (unitLower === 'g' || unitLower === 'グラム') {
                    normalizedUnitPrice = unitPrice * 100;
                    normalizedUnit = '100g';
                } else if (unitLower === 'ml' || unitLower === 'ミリリットル') {
                    normalizedUnitPrice = unitPrice * 100;
                    normalizedUnit = '100ml';
                }

                const newItem = { 
                    date: dateInput.value, 
                    name: itemNameInput.value.trim(), 
                    brand: brandNameInput.value.trim(), // 銘柄を追加
                    price: price,
                    quantity: quantity,
                    unit: unit,
                    unitPrice: unitPrice,
                    normalizedUnitPrice: normalizedUnitPrice,
                    normalizedUnit: normalizedUnit,
                    store: storeNameInput.value.trim(), 
                    createdAt: serverTimestamp() 
                };

                if (newItem.name && !isNaN(newItem.price)) {
                    await addDoc(collection(db, "users", currentUserId, "items"), newItem);
                    itemForm.reset();
                    quantityInput.value = '1';
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            });

            itemSelect.addEventListener('change', renderChart);
            
            showIdBtn.addEventListener('click', () => {
                if (currentUserId) {
                    myIdDisplay.textContent = currentUserId;
                    myIdDisplay.style.display = 'block';
                }
            });

            syncBtn.addEventListener('click', () => {
                const newId = syncIdInput.value.trim();
                if (newId && newId.length > 20) {
                    if (confirm(`現在のデータを破棄し、新しいIDと同期しますか？`)) {
                        localStorage.setItem('shoppingDashboardUserId', newId);
                        location.reload();
                    }
                } else {
                    alert("有効な同期IDを入力してください。");
                }
            });
        }
    </script>
</body>
</html>


